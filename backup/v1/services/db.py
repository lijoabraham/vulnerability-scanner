from sqlalchemy.orm import Session
import json
from sqlalchemy import select, bindparam
from api.v1.models.users import User
from api.v1.schemas.user import CreateUser
from api.v1.schemas.scan import ScanItem
from api.v1.schemas.scan_model import Scan
# from api.v1.models.scans import Scan


def create_user(db:Session, user:CreateUser):
    db_user = User(email=user.email, hashed_password=user.hashed_password.encode('utf-8'), full_name=user.full_name, is_active=user.is_active)
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user

async def create_scan(db:Session, scan_data: ScanItem):
    db_scan = Scan(name=scan_data.name, info=json.dumps(scan_data.info), status=1)
    await db.insert(Scan, db_scan.__dict__)
    return db_scan

async def get_scan(db: Session, scan_id: int):
    return await db.fetch_one(select(Scan).filter(Scan.id == bindparam('scan_id')), {'scan_id': scan_id})